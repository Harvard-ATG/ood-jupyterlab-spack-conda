#!/usr/bin/env bash

this_script="template/script.sh.erb"

log() {
    echo -e "[$(date -Iseconds)][${this_script}] $1"
}

# Benchmark info
log "Starting main script"

log "HOME=$HOME"

# Set working directory to home directory
cd "${HOME}"

# Select spack and conda environment based on form selection
log "Spack install location directive from form: <%= context.environment %>"
if [[ "<%= context.environment %>" == "course" ]]; then
    # spack_root="/shared/courseSharedFolders/<%= context.course %>outer/<%= context.course %>/spack"
    spack_root="/shared/spack"
    spack_environment="<%= context.spack %>"
    # conda_environment="<%= context.conda %>"
    conda_environment="/shared/courseSharedFolders/<%= context.course %>outer/<%= context.course %>/<%= context.conda %>"
    # Check user access to conda environment
    echo "Running ls on $conda_environment to check permissions"
    ls $conda_environment
else
    spack_root="/shared/spack"
    spack_environment="<%= context.spack %>"
    conda_environment="<%= context.conda %>"
fi

# Load spack
log "Spack root: $spack_root"
. $spack_root/share/spack/setup-env.sh
log "Activated spack install"

#
# Start Jupyter Notebook Server
#

# Load the required environment
log "Loading spack environment: $spack_environment"
spack env activate $spack_environment
log "Spack environment loaded"

# List loaded modules
spack find

# Benchmark info
log "Starting jupyter..."

# Activate conda environment
log "Loading conda environment: $conda_environment"
set -x
eval "$(command conda 'shell.bash' 'hook' 2> /dev/null)"
conda activate $conda_environment
set +x

# Launch the Jupyter Lab Server
jupyter lab --config="${CONFIG_FILE}" <%= context.extra_jupyter_args %>
